<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stopwatch</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM (via ESM) -->
    <script type="importmap">
        {
            "imports": {
                "react": "https://esm.sh/react@18.2.0",
                "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
                "lucide-react": "https://esm.sh/lucide-react@0.263.1"
            }
        }
    </script>
    
    <!-- Babel for in-browser JSX compilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* Custom scrollbar hiding */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        /* Monospace font tweak for tabular numbers stability */
        .font-mono-nums {
            font-variant-numeric: tabular-nums;
        }
    </style>
</head>
<body class="bg-black text-white h-screen overflow-hidden">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { Moon, Sun, Monitor, Maximize, Minimize } from 'lucide-react';

        // --- Utility Functions ---

        const formatStopwatch = (time) => {
            const h = Math.floor(time / 3600000);
            const m = Math.floor((time / 60000) % 60);
            const s = Math.floor((time / 1000) % 60);
            
            if (h > 0) {
                return `${h}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
            }
            return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        };

        // --- Custom Hooks ---

        const useKeepScreenOn = (isActive) => {
            const wakeLockRef = useRef(null);

            useEffect(() => {
                const requestLock = async () => {
                    if ('wakeLock' in navigator) {
                        try {
                            wakeLockRef.current = await navigator.wakeLock.request('screen');
                        } catch (err) {
                            console.warn('Wake Lock error:', err);
                        }
                    }
                };

                const releaseLock = async () => {
                    if (wakeLockRef.current) {
                        try {
                            await wakeLockRef.current.release();
                            wakeLockRef.current = null;
                        } catch (err) {
                            console.warn('Wake Lock release error:', err);
                        }
                    }
                };

                const handleVisibilityChange = async () => {
                    if (document.visibilityState === 'visible' && isActive) {
                        await requestLock();
                    }
                };

                if (isActive) {
                    requestLock();
                    document.addEventListener('visibilitychange', handleVisibilityChange);
                } else {
                    releaseLock();
                }

                return () => {
                    releaseLock();
                    document.removeEventListener('visibilitychange', handleVisibilityChange);
                };
            }, [isActive]);
        };

        // --- Components ---

        const StopwatchView = ({ time, isRunning, toggleStart, handleReset, isDark }) => {
            const mainText = isDark ? 'text-white' : 'text-black';
            
            // Check if we have hours to adjust font size scaling for width
            const hasHours = Math.floor(time / 3600000) > 0;
            // 72vh is approx 75% of screen height. 
            // 19vw allows roughly 5 characters (00:00) to fit width.
            // 13vw allows roughly 7-8 characters (0:00:00) to fit width.
            const fontSizeStyle = {
                fontSize: `min(${hasHours ? '13vw' : '19vw'}, 72vh)`
            };

            const resetBtnClass = `w-24 h-24 rounded-full flex items-center justify-center transition-all ${
                isRunning 
                    ? 'opacity-50 cursor-not-allowed ' + (isDark ? 'bg-[#333333]' : 'bg-[#E5E5EA]')
                    : 'active:bg-opacity-70 ' + (isDark ? 'bg-[#333333] hover:bg-[#444]' : 'bg-[#E5E5EA] hover:bg-[#D1D1D6]')
            }`;
            const resetTextClass = `text-lg font-medium ${isDark ? 'text-white' : 'text-black'}`;
            
            const startStopBtnClass = `w-24 h-24 rounded-full flex items-center justify-center active:opacity-70 transition-all ${
                isRunning 
                    ? (isDark ? 'bg-[#330E0C] text-[#FF453A] hover:bg-[#421210]' : 'bg-[#FFDADB] text-[#FF3B30] hover:bg-[#FFC6C7]') 
                    : (isDark ? 'bg-[#0A2A12] text-[#30D158] hover:bg-[#0D3617]' : 'bg-[#DAFAD9] text-[#248A3D] hover:bg-[#C2F5C0]')
            }`;

            return (
                <div className="flex-1 flex flex-col items-center w-full pt-4 h-full overflow-hidden">
                    {/* Timer Display - Flexible container */}
                    <div className="flex-1 flex items-center justify-center w-full">
                        <div 
                            className={`font-light font-mono-nums tracking-tight ${mainText} leading-none transition-all duration-300`}
                            style={fontSizeStyle}
                        >
                            {formatStopwatch(time)}
                        </div>
                    </div>

                    {/* Controls */}
                    <div className="flex w-full max-w-sm md:max-w-xl justify-between px-8 mb-8 md:mb-12 flex-none z-10">
                        <button 
                            onClick={handleReset}
                            disabled={isRunning}
                            className={resetBtnClass}
                        >
                            <span className={resetTextClass}>
                                Reset
                            </span>
                        </button>

                        <button 
                            onClick={toggleStart}
                            className={startStopBtnClass}
                        >
                            <span className="text-lg font-medium">
                                {isRunning ? 'Stop' : 'Start'}
                            </span>
                        </button>
                    </div>
                </div>
            );
        };

        // --- Main App ---

        function StopwatchApp() {
            // Theme State
            const [themeMode, setThemeMode] = useState('system'); 
            const [systemIsDark, setSystemIsDark] = useState(false);

            // Stopwatch State (Lifted)
            const [time, setTime] = useState(0);
            const [isRunning, setIsRunning] = useState(false);
            const timerRef = useRef(null);
            
            // Alarm State
            const [blinkOn, setBlinkOn] = useState(false);

            // Fullscreen State
            const [isFullScreen, setIsFullScreen] = useState(false);

            useKeepScreenOn(isRunning);

            // Theme Effect
            useEffect(() => {
                const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
                setSystemIsDark(mediaQuery.matches);
                const handler = (e) => setSystemIsDark(e.matches);
                mediaQuery.addEventListener('change', handler);
                return () => mediaQuery.removeEventListener('change', handler);
            }, []);

            // Fullscreen Listener
            useEffect(() => {
                const handleFullScreenChange = () => {
                    setIsFullScreen(!!document.fullscreenElement);
                };
                document.addEventListener('fullscreenchange', handleFullScreenChange);
                return () => document.removeEventListener('fullscreenchange', handleFullScreenChange);
            }, []);

            // Stopwatch Logic
            useEffect(() => {
                if (isRunning) {
                    const startTime = Date.now() - time;
                    timerRef.current = setInterval(() => {
                        setTime(Date.now() - startTime);
                    }, 10);
                } else {
                    clearInterval(timerRef.current);
                }
                return () => clearInterval(timerRef.current);
            }, [isRunning]);

            // Alarm Blink Logic
            const isAlarmCondition = time >= 600000; // 10 minutes = 600,000 ms

            useEffect(() => {
                let blinkInterval;
                if (isAlarmCondition) {
                    blinkInterval = setInterval(() => {
                        setBlinkOn(prev => !prev);
                    }, 1000); // Blink every second
                } else {
                    setBlinkOn(false);
                }
                return () => clearInterval(blinkInterval);
            }, [isAlarmCondition]);

            // Handlers
            const toggleStart = () => setIsRunning(!isRunning);
            const handleReset = () => setTime(0);
            
            const toggleFullScreen = () => {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen().catch(err => {
                        console.warn(`Error attempting to enable full-screen mode: ${err.message}`);
                    });
                } else {
                    if (document.exitFullscreen) {
                        document.exitFullscreen();
                    }
                }
            };

            // Styles
            const isDark = themeMode === 'system' ? systemIsDark : themeMode === 'dark';

            // Background Logic
            let appBg;
            if (isAlarmCondition && blinkOn) {
                appBg = 'bg-pink-500';
            } else {
                appBg = isDark ? 'bg-black' : 'bg-[#F2F2F7]';
            }
            
            const navColor = isDark ? 'text-white' : 'text-black';

            const cycleTheme = () => {
                if (themeMode === 'system') setThemeMode('light');
                else if (themeMode === 'light') setThemeMode('dark');
                else setThemeMode('system');
            };

            const getThemeIcon = () => {
                if (themeMode === 'system') return <Monitor size={20} />;
                if (themeMode === 'light') return <Sun size={20} />;
                return <Moon size={20} />;
            };

            return (
                <div className={`h-screen w-screen flex flex-col font-sans selection:bg-orange-500 selection:text-white transition-colors duration-300 ${appBg} ${navColor}`}>
                    
                    <header className="flex-none relative flex items-center justify-between px-6 pt-6 pb-2 z-20">
                        <button 
                            onClick={cycleTheme}
                            className={`p-2 rounded-full transition-colors flex items-center space-x-2 ${
                                isDark ? 'bg-[#1C1C1E] text-gray-300 hover:text-white' : 'bg-white text-gray-600 hover:text-black shadow-sm'
                            }`}
                            title={`Current: ${themeMode.charAt(0).toUpperCase() + themeMode.slice(1)} Mode`}
                        >
                            {getThemeIcon()}
                            <span className="text-sm font-medium hidden md:block">
                                {themeMode.charAt(0).toUpperCase() + themeMode.slice(1)}
                            </span>
                        </button>
                        
                        <div className={`absolute left-1/2 transform -translate-x-1/2 text-xl font-medium ${isDark ? 'text-gray-300' : 'text-gray-700'}`}>
                            Stopwatch
                        </div>

                        <button 
                            onClick={toggleFullScreen}
                            className={`p-2 rounded-full transition-colors flex items-center justify-center ${
                                isDark ? 'bg-[#1C1C1E] text-gray-300 hover:text-white' : 'bg-white text-gray-600 hover:text-black shadow-sm'
                            }`}
                            title={isFullScreen ? "Exit Full Screen" : "Enter Full Screen"}
                        >
                            {isFullScreen ? <Minimize size={20} /> : <Maximize size={20} />}
                        </button>
                    </header>

                    <main className="flex-1 flex flex-col relative overflow-hidden">
                        <StopwatchView 
                            time={time} 
                            isRunning={isRunning} 
                            toggleStart={toggleStart} 
                            handleReset={handleReset} 
                            isDark={isDark} 
                        />
                    </main>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<StopwatchApp />);
    </script>
</body>
</html>